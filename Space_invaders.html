<!DOCTYPE html>
<html>
    <head>
        <title>Space Invaders</title>
		<style>
			canvas{
				border: solid;
				background-color: black;
			}
		</style>
		
		<!-- Import external scripts -->
			<script src="arrays+.js"></script>
			<script src="vectors.js"></script>
			<script src="objects+.js"></script>
		<!-- -->
		
    </head>
    
	<body onload="loaded();" bgColor="grey">
		<!-- loading area -->
			<img src="Favicon.ico" id="img_ship" onload="this.loaded = true" hidden="true"/>
			<img src="Favicon.ico" id="img_enemy" onload="this.loaded = true" hidden="true"/>
			<img src="Favicon.ico" id="img_bullet" onload="this.loaded = true" hidden="true"/>
		<!-- -->
		
        <canvas id='canvas'>
			This Browser Does Not Support Canvas.
		</canvas>
    </body>
	
    <script>
		/* initialization of variables */
		
		// stuff for drawing
		var canvas = document.getElementById('canvas');
		var ctx = canvas.getContext('2d');
		ctx.fillStyle = "white";
		
		canvas.height = 560;//window.innerHeight - 30;
		canvas.width = 1250;//window.innerWidth - 30;
		
		var frameRate = 32;
		// set up interval for each tick
		var t = window.setInterval();
		
		
		// for images
		var img_ship = document.getElementById('img_ship'); img_ship.loaded = false;
		var img_enemy = document.getElementById('img_enemy'); img_enemy.loaded = false;
		var img_bullet = document.getElementById('img_bullet'); img_bullet.loaded = false;
		
		
		// the levels
		var enemyLevelClusters = [// level 1
							 [[1,1,1,1,1,1,1,1],
							  [1,0,0,1,1,0,0,1],
							  [1,0,0,1,1,0,0,1],
							  [1,1,1,0,0,1,1,1],
							  [1,0,0,0,0,0,0,1],
							  [1,0,0,0,0,0,0,1],
							  [1,0,0,1,1,0,0,1],
							  [1,1,1,1,1,1,1,1]],
							 
							 // level 2
							 [[1,1,1,1,1,1,1,1],
							  [1,0,0,1,1,0,0,1],
							  [1,0,0,1,1,0,0,1],
							  [1,1,1,0,0,1,1,1],
							  [1,1,1,0,0,1,1,1],
							  [1,0,0,1,1,0,0,1],
							  [1,0,0,1,1,0,0,1],
							  [1,1,1,1,1,1,1,1]]
							 
							 ];
		
		
		// key detection
		var Arrows = {left: 37, up: 38, right: 39, down: 40 };
		var PressedKeys = {left: false, up: false, right: false};
		document.onkeydown = function(e){
			var code = e.keyCode || e.which;
			switch (code){
				case Arrows.up:
					PressedKeys.up = true;
					break;
				case Arrows.left:
					PressedKeys.left = true;
					break;
				case Arrows.right:
					PressedKeys.right = true;
					break;
				default:
					break;
			}
		}
		document.onkeyup = function(e){
			var code = e.keyCode || e.which;
			switch (code){
				case Arrows.up:
					PressedKeys.up = false;
					break;
				case Arrows.left:
					PressedKeys.left = false;
					break;
				case Arrows.right:
					PressedKeys.right = false;
					break;
				default:
					break;
			}
		}
		
		/* */
		
		
		function loaded(){
			// if all loaded
			if (img_bullet.loaded && img_enemy.loaded && img_ship.loaded){
				console.log("done loading");
			} else {
				console.log("still loading");
				window.setTimeout(load,1000);
			}
		}
		
		
		/* Enemy Class */
		var Enemies = [];
		var EnemyOffsetRef = 0;
		function Enemy(x, y) {
			this.id = Enemies.length;
			
			/*
				properties with the prefix _ notates a position in a matrix, from which the position on canvas is determined.
				this.x and this.y are the literal positions on canvas
			*/
			
			// set up position property
			this.pos = new Vector2d();
			
			// uses supplied x if not null, otherwise determined by id
			this._x = x!=null ? x : this.id % 8;
			this.pos.x = 25 + this._x * 50;
			
			// uses supplied y if not null, otherwise determined by id
			this._y = y!=null ? y : Math.floor(this.id / 8);
			this.pos.y = 25 + this._y * 50;
			
			// set up velocity
			this.vel = new Vector2d(3,0)
			
			this.width = 30;
			this.height = 30;
			
			// function to draw this enemy
			this.drawMe = function(){
				ctx.fillStyle = "white";
				ctx.fillRect(this.pos.x, this.pos.y, this.width, this.height);
			};
			
			// update per tick
			this.update = function(){
				
				// bounce off imaginary walls
				if (this.pos.x - this._x * 50 + 25 >= 860 || this.pos.x - this._x * 50 <= 24){
					this.vel.x = this.vel.x * -1;
				}
				
				this.pos._add(this.vel)
				
				this.drawMe();
			}
			
			// add this enemy to the array containing all enemies
			Enemies.push(this);
		}
		/**/
		
		
		/* Bullet Class */
		var Bullets = [];
		var BulletIdRef = 0;
		function Bullet(pos, vel, isBomb) {
			this.id = BulletIdRef++;
			
			// set position and velocity
			this.pos = pos || new Vector2d(0,0);
			this.vel = vel || new Vector2d(0,0);
			
			this.height = 20;
			this.width = 10;
			
			// update for each tick
			this.update = function (){
				
				// move based on vel
				this.pos._add(this.vel);
				
				// remove from Bullets and stop function if offscreen
				if (this.pos.y + this.height < 0){
					Bullets.splice(Bullets.indexOf(this), 1);
					return;
				}
				
				// make collision logic here, going in reverse ensures that all enemies are checked
				for (var i = Enemies.length - 1; i >= 0; i--){
					if (this.intersectsWith(Enemies[i])){
						Enemies.splice(i,1);
						Bullets.splice(Bullets.indexOf(this),1);
						return;
					}
				}
				
				// draw it
				this.drawMe();
				
			};
			
			// function to draw this bullet
			this.drawMe = function(){
				ctx.fillRect(this.pos.x, this.pos.y, this.width, this.height);
			};
			
			Bullets.push(this);
		}
		/* */
		
		
		/* Ship Class */
		var ship = new Ship();
		function Ship(){
			
			this.reset = function(){
				this.width = 30;
				this.pos = new Vector2d((canvas.width / 2) - (this.width / 2), canvas.height - 5 - this.width);
				this.vel = new Vector2d();
				this.maxSpeed = 10;
			}
			
			
			this.width = 30;
			
			this.pos = new Vector2d((canvas.width / 2) - (this.width / 2), canvas.height - 5 - this.width);
			this.vel = new Vector2d();
			
			this.maxSpeed = 10;
			
			this.drawMe = function(){
				ctx.fillRect(this.pos.x, this.pos.y, this.width, this.width)
			}
			
			this.update = function(){
				
				/* update velocity */
				if (PressedKeys.left){
					this.vel.x -= (this.vel.x > -this.maxSpeed)*(this.maxSpeed/4);
				}
				if (PressedKeys.right){
					this.vel.x += (this.vel.x < this.maxSpeed)*(this.maxSpeed/4);
				}
				/* */
				
				// fire
				if (PressedKeys.up){
					this.fire();
					PressedKeys.up = false;
				}
				
				// update position
				this.pos._add(this.vel);
				
				// make sure it doesn't go out of bounds
				if (this.pos.x > canvas.width - this.width || this.pos.x < 0){
					this.pos.x = (canvas.width - this.width) * (this.pos.x > canvas.width - this.width);
					this.vel.x = 0;
				}
				
				// slow it down
				this.vel.x = this.vel.x * 0.9;
				
				// draw it
				this.drawMe();
			}
			
			this.fire = function(){
				// make a bullet with a position of exactly the middle of the ship, and a velocity of 10 going up
				new Bullet(new Vector2d(this.pos.x + this.width/2 - 10/2, this.pos.y), new Vector2d(0,-10));
			}
		}
		/* */
		
		
		// the actual tick function
		function tick(){
			
			// clear the screen
			ctx.clearRect(0,0,canvas.width, canvas.height);
			
			
			// (find way to update all bullets and enemies in same loop)
			// update all enemies
			for (var i = 0; i < Enemies.length; i++){
				Enemies[i].update();
			}
			
			
			// update all Bullets, going in reverse insures that all bullets are updated
			// a bullet would be skipped if the one before it was spliced, unless caught and coded for, reverse is just easier
			for (var i = Bullets.length - 1; i >= 0; i--){
				Bullets[i].update();
			}
			
			
			// update the ship
			ship.update();
			
			
			// check if win
			if (Enemies.length == 0){
				window.clearInterval(t);
				alert("!!!  YOU WIN  !!!");
			}
		}
		
		function startLevel(level){
			resetAll();
			
			var levelGrid = enemyLevelClusters[level - 1];
			// loop through each position in grid
			for (var i = 0; i < levelGrid.length; i++){
				for (var ii = 0; ii < levelGrid[i].length; ii++){
					// if the position is on, make an enemy their
					if (levelGrid[i][ii]) new Enemy(ii,i);
				}
			}
			
			t = window.setInterval(tick, 1000/32);
		}
		
		function resetAll(){
			// move ship back
			ship.reset();
			
			// empty arrays
			Enemies = [];
			Bullets = [];
			
			// clear the screen
			ctx.clearRect(0,0,canvas.width, canvas.height);
			
			// turn off all intervals
			window.clearInterval(t);
			
		}
		
		
		/**** START THE GAME ****/
		
		startLevel(1);
		
		/****  ****/
    </script>
    
    
</html>
